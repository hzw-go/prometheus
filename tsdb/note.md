**笔记**

# 重要概念
- 标签（Label）：一个 <string, string> 的 KV
- 序列（Series）：多个 Label 的集合，{k1: v1, k2: v2, …}
- 数据块（Chunk）：TSDB 在磁盘中存储的 <T, V> 数据
- Index：TSDB 用于定位 Label 和 Series 以及对应的 <T, V> 时间系列的位置
- meta.json：人类可读的用于了解一个 Chunk 包含的数据范围的描述文件

一个series独占一个文件
- 文件非常多，容易达到进程最大打开文件数
- 每次持久化的文件非常多
- 删除的过期文件也非常多
- 最近的数据查询频率高
> 时序场景下，数据的查询、删除与时间密切相关，与series维度关联度不强

按时间分块存储
- 按需读取指定时间范围内的文件
- 删除指定的文件即可清理过期数据

目录结构
```
./data
├── b-000001
│   ├── chunks
│   │   ├── 000001
│   │   ├── 000002
│   │   └── 000003
│   ├── index
│   └── meta.json
```
data下一级目录是以b-为前缀，自增id为后缀的目录，代表block，一个block包含
- chunks：存放chunk数据，一个chunk包含很多序列
- index：对chunk的索引，快速定位序列以及数据所在的文件
- meta.json：描述block数据和状态的文件

设计思想
- 按照时间维度切分成多个block
- 每个block都是一个独立的数据库
- block之间完全没有交叉
- 每个block的文件都不可修改
- 只有最近的block允许接收数据，接收的数据先写入内存，同时也会写一份WAL
> 完全借鉴了LSM思想，并针对时序场景做了一些优化

label查询
- label-series倒排索引
- seriesID-series正排索引
- seriesID有序集合求交集/并集

WAL
- 数据目录是只读的，只有两种写情况：创建、压缩
- 最新数据存放在内存中
- 通过WAL保证持久性

源码目录结构
- chunknc
  - 提供时序点数据的编码格式，定义了Chunk接口，包含Appender、Iterator方法，还给出了Chunk的实现XORChunk
  - Chunk为一组数据点（t，v）的集合，通过Appender写入，通过Iterator遍历
- chunks
  - chunk的持久化：持久化chunk到segment文件，保存chunkRef
  - chunk的读取：从磁盘中读取segment文件，通过chunkRef查询chunk
  - head_chunks：todo

mmap
- mmap对文件对读写只需要从磁盘到用户主存一次拷贝，跳过了内核空间
- 操作mmap映射后的文件，就像操作内存一样
- mmap会消耗虚拟内存，所以文件过大时，可以考虑只映射需要的那部分


# index
- 以文件的形式，存储在block目录下
- 一个block对应一个index文件
- 为当前block下的所有label建立索引
## 文件格式

```
┌────────────────────────────┬─────────────────────┐
│ magic(0xBAAAD700) <4b>     │ version(1) <1 byte> │
├────────────────────────────┴─────────────────────┤
│ ┌──────────────────────────────────────────────┐ │
│ │                 Symbol Table                 │ │
│ ├──────────────────────────────────────────────┤ │
│ │                    Series                    │ │
│ ├──────────────────────────────────────────────┤ │
│ │                 Label Index 1                │ │
│ ├──────────────────────────────────────────────┤ │
│ │                      ...                     │ │
│ ├──────────────────────────────────────────────┤ │
│ │                 Label Index N                │ │
│ ├──────────────────────────────────────────────┤ │
│ │                   Postings 1                 │ │
│ ├──────────────────────────────────────────────┤ │
│ │                      ...                     │ │
│ ├──────────────────────────────────────────────┤ │
│ │                   Postings N                 │ │
│ ├──────────────────────────────────────────────┤ │
│ │               Label Offset Table             │ │
│ ├──────────────────────────────────────────────┤ │
│ │             Postings Offset Table            │ │
│ ├──────────────────────────────────────────────┤ │
│ │                      TOC                     │ │
│ └──────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────┘
```
### Symbol Table
记录该block涉及的所有label的name、value字符串；通过编号引用字符串，优化index文件大小。

Symbol Table文件格式如下，其中：
- len表示整个ST的长度
- symbols表示字符串的个数
- len(str_x)表示字符串长度
- str_x表示字符串的内容
- CRC32表示整个ST的校验码
```
┌────────────────────┬─────────────────────┐
│ len <4b>           │ #symbols <4b>       │
├────────────────────┴─────────────────────┤
│ ┌──────────────────────┬───────────────┐ │
│ │ len(str_1) <uvarint> │ str_1 <bytes> │ │
│ ├──────────────────────┴───────────────┤ │
│ │                . . .                 │ │
│ ├──────────────────────┬───────────────┤ │
│ │ len(str_n) <uvarint> │ str_n <bytes> │ │
│ └──────────────────────┴───────────────┘ │
├──────────────────────────────────────────┤
│ CRC32 <4b>                               │
└──────────────────────────────────────────┘
```
### Series
记录该block所有的series，并按照labels排序。

每条series按照16字节对齐。
```
┌───────────────────────────────────────┐
│ ┌───────────────────────────────────┐ │
│ │   series_1                        │ │
│ ├───────────────────────────────────┤ │
│ │                 . . .             │ │
│ ├───────────────────────────────────┤ │
│ │   series_n                        │ │
│ └───────────────────────────────────┘ │
└───────────────────────────────────────┘
```
在每个series中，先记录了label的个数，然后是具体的label信息：name、value在Symbol Table的编号。

之后是该series的chunk个数，以及每个chunk的minTime、maxTime、ref。值得注意的是，第二个及以后的chunk的这三个字段存储的是差值：ref存储与上一个chunk的差值，minTime存储与上一个maxTime的差值，maxTime存储与当前chunk的minTime的差值。

`通过label查找series，再通过时间范围查找chunk`
```
┌──────────────────────────────────────────────────────────────────────────┐
│ len <uvarint>                                                            │
├──────────────────────────────────────────────────────────────────────────┤
│ ┌──────────────────────────────────────────────────────────────────────┐ │
│ │                     labels count <uvarint64>                         │ │
│ ├──────────────────────────────────────────────────────────────────────┤ │
│ │              ┌────────────────────────────────────────────┐          │ │
│ │              │ ref(l_i.name) <uvarint32>                  │          │ │
│ │              ├────────────────────────────────────────────┤          │ │
│ │              │ ref(l_i.value) <uvarint32>                 │          │ │
│ │              └────────────────────────────────────────────┘          │ │
│ │                             ...                                      │ │
│ ├──────────────────────────────────────────────────────────────────────┤ │
│ │                     chunks count <uvarint64>                         │ │
│ ├──────────────────────────────────────────────────────────────────────┤ │
│ │              ┌────────────────────────────────────────────┐          │ │
│ │              │ c_0.mint <varint64>                        │          │ │
│ │              ├────────────────────────────────────────────┤          │ │
│ │              │ c_0.maxt - c_0.mint <uvarint64>            │          │ │
│ │              ├────────────────────────────────────────────┤          │ │
│ │              │ ref(c_0.data) <uvarint64>                  │          │ │
│ │              └────────────────────────────────────────────┘          │ │
│ │              ┌────────────────────────────────────────────┐          │ │
│ │              │ c_i.mint - c_i-1.maxt <uvarint64>          │          │ │
│ │              ├────────────────────────────────────────────┤          │ │
│ │              │ c_i.maxt - c_i.mint <uvarint64>            │          │ │
│ │              ├────────────────────────────────────────────┤          │ │
│ │              │ ref(c_i.data) - ref(c_i-1.data) <varint64> │          │ │
│ │              └────────────────────────────────────────────┘          │ │
│ │                             ...                                      │ │
│ └──────────────────────────────────────────────────────────────────────┘ │
├──────────────────────────────────────────────────────────────────────────┤
│ CRC32 <4b>                                                               │
└──────────────────────────────────────────────────────────────────────────┘
```

### Label index
记录label name与value的映射关系，每个label index记录一个label name到所有value的映射。

names记录label name的个数，通常为1；entries记录value的个数；接下来是value在Symbol Table的引用编号。
```
┌───────────────┬────────────────┬────────────────┐
│ len <4b>      │ #names <4b>    │ #entries <4b>  │
├───────────────┴────────────────┴────────────────┤
│ ┌─────────────────────────────────────────────┐ │
│ │ ref(value_0) <4b>                           │ │
│ ├─────────────────────────────────────────────┤ │
│ │ ...                                         │ │
│ ├─────────────────────────────────────────────┤ │
│ │ ref(value_n) <4b>                           │ │
│ └─────────────────────────────────────────────┘ │
│                      . . .                      │
├─────────────────────────────────────────────────┤
│ CRC32 <4b>                                      │
└─────────────────────────────────────────────────┘
```

### Postings
存储了一个label相关的所有series（已排序），其中entries为series个数，随后是每个series的ref
```
┌────────────────────┬────────────────────┐
│ len <4b>           │ #entries <4b>      │
├────────────────────┴────────────────────┤
│ ┌─────────────────────────────────────┐ │
│ │ ref(series_1) <4b>                  │ │
│ ├─────────────────────────────────────┤ │
│ │ ...                                 │ │
│ ├─────────────────────────────────────┤ │
│ │ ref(series_n) <4b>                  │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ CRC32 <4b>                              │
└─────────────────────────────────────────┘
```

### Offset Table
记录了一个label在posting的位置，用于查找posting部分，从而得到此label下的所有series。

值得注意的是这里以字符串形式存储了label，而不是存储Symbol Table引用
```
┌─────────────────────┬──────────────────────┐
│ len <4b>            │ #entries <4b>        │
├─────────────────────┴──────────────────────┤
│ ┌────────────────────────────────────────┐ │
│ │  n = 2 <1b>                            │ │
│ ├──────────────────────┬─────────────────┤ │
│ │ len(name) <uvarint>  │ name <bytes>    │ │
│ ├──────────────────────┼─────────────────┤ │
│ │ len(value) <uvarint> │ value <bytes>   │ │
│ ├──────────────────────┴─────────────────┤ │
│ │  offset <uvarint64>                    │ │
│ └────────────────────────────────────────┘ │
│                    . . .                   │
├────────────────────────────────────────────┤
│  CRC32 <4b>                                │
└────────────────────────────────────────────┘
```
### TOC
Table Of Content，存储各部分在index文件中的偏移量






# 遗留问题
- 为什么一个block下的series、chunk数量不同？series和chunk的是什么关系？
```
"stats": {
    "numSamples": 124326,
    "numSeries": 563,
    "numChunks": 1497
},
```
｜ 可能是chunk有大小限制、时间间隔限制，使得一个series的时序点分成了多个chunk
- 如何通过编号在Symbol Table中寻找字符串
